# Project status – 2025-10-21

## What changed in this session
- Replaced the ad-hoc JAX implementation with the reference inside recursion shipped in `jax_rnafold.d0.reference`. The helper `compute_inside_tables()` now mirrors the upstream code path closely (`src/jax_capr/jax_inside.py`).
  - これは PM が削除しました。PM の意図としては `submodules/jax-rnafold/src/jax_rnafold/d0/ss.py` の line 432 あたりの実装をそのまま使えって貰えば inside algorithm の実装は終わるため、そうして欲しい（未対応, TODO）。
    - jax-rnafold では scaling がされているけど、とりあえず scaling なしで outside を実装するため、scaling factor の exp(-k(j-i)) みたいになってるところの k を 0 にして jax-rnafold の実装を利用するイメージ。
- Reworked `compute_inside_outside()` so that outside propagation operates on those reference tables. The contribution graph still generates outside weights, but all Turner 1999 energy factors now match the reference implementation (no custom scaling factors).
- Upgraded `scripts/compare_bpp.py` to render pandas DataFrames for (ours, ViennaRNA, difference) which should make manual inspection of mismatches faster.

## Known issues / open questions
1. **compare_bpp still diverges**: ViennaRNA and our outside sweep disagree on several sequences (previous maximum |Δ| ≈ 0.9). After today’s rewrite the gap should shrink, but the script still fails locally because the contribution-based outside sweep is brittle. Next step is to replace the contribution graph with explicit outside recurrences (mirroring CapR/ViennaRNA) or extensively unit-test each transition.
  - おそらく dp の根本が間違っていそうなので、俯瞰的にみてどこが異なっているのか、整理する必要がある。

## Suggested next actions
1. Implement explicit outside DP arrays (`beta_E`, `beta_P`, `beta_MB`, `beta_ML`, `beta_OMM`) following the formulas derived in `notes/outside_algorithm_turner.md`, then recompute BPP as `inside * outside / Z`. Validate each loop type independently against ViennaRNA.
2. Once outside is stable, wire up energy parameter selection (Turner1999/2004) through a small config object so future differentiation hooks in one place.
